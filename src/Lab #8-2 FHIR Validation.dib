#!meta

{"kernelInfo":{"defaultKernelName":"csharp","items":[{"name":"csharp","languageName":"C#","aliases":["c#","cs"]},{"name":"fsharp","languageName":"F#","aliases":["f#","fs"]},{"name":"html","languageName":"HTML"},{"name":"http","languageName":"HTTP"},{"name":"javascript","languageName":"JavaScript","aliases":["js"]},{"name":"kql","languageName":"KQL"},{"name":"mermaid","languageName":"Mermaid"},{"name":"pwsh","languageName":"PowerShell","aliases":["powershell"]},{"name":"sql","languageName":"SQL"},{"name":"value"}]}}

#!csharp

#r "nuget:Firely.Fhir.Validation"
#r "nuget:Firely.Fhir.Validation.R4"
#r "nuget:Firely.Fhir.Validation.Compilation"
#r "nuget:hl7.fhir.r4"
#r "nuget:Firely.Fhir.Packages"

#!csharp

using Firely.Fhir.Packages;
using Firely.Fhir.Validation;
using Hl7.Fhir.Model;
using Hl7.Fhir.Rest;
using Hl7.Fhir.Serialization;
using Hl7.Fhir.Specification;
using Hl7.Fhir.Specification.Source;
using Hl7.Fhir.Specification.Terminology;
using Hl7.Fhir.Support;
using Hl7.Fhir.Utility;
using System.IO;

#!csharp

var packageSource = FhirPackageSource.CreateCorePackageSource(ModelInfo.ModelInspector, FhirRelease.R4, "https://packages.simplifier.net");
IAsyncResourceResolver  _coreSource = new CachedResolver(packageSource);
var directorySource1 = new CachedResolver(new DirectorySource("C:\\Hongyu\\Data\\ig\\twcore\\package",
                            new DirectorySourceSettings { IncludeSubDirectories = true }));
                            
var directorySource2 = new CachedResolver(new DirectorySource("C:\\Hongyu\\Data\\ig\\ngs\\package",
                            new DirectorySourceSettings { IncludeSubDirectories = true }));

var profileSource = new MultiResolver(directorySource1,directorySource2, _coreSource);

var terminologySource = new LocalTerminologyService(profileSource);

var validator = new Validator(profileSource, terminologySource);

#!csharp

// read patient resource from file
var patientJson = File.ReadAllText(@"C:\Hongyu\Data\ig\ngs\package\example\Patient-pat-min.json");

var patient = new FhirJsonDeserializer().Deserialize<Resource>(patientJson) as Patient;

#!csharp

patient.Gender = null; // make it invalid by removing required element

#!csharp

var result = validator.Validate(patient);
foreach (var issue in result.Issue)
{
    Console.WriteLine($"{issue.Severity} - {issue.Details.Text}");
}

#!csharp

result

#!csharp

// print profile url
foreach (var profile in patient.Meta.Profile)
{
    Console.WriteLine(profile);
}

#!csharp

var profile = "https://nhicore.nhi.gov.tw/ngs/StructureDefinition/Patient-twngs";
result = validator.Validate(patient, profile);
foreach (var issue in result.Issue)
{
    Console.WriteLine($"{issue.Severity} - {issue.Details.Text}");
}

#!csharp

// read a bundle object from a file
var esBuldle = File.ReadAllText(@"C:\Hongyu\Data\ig\ngs\package\example\Bundle-bun-lung-min.json");

var bundle = new FhirJsonDeserializer().Deserialize<Bundle>(esBuldle);

var result = validator!.Validate(bundle);

// print the result 
foreach (var issue in result.Issue)
{
    Console.WriteLine($"{issue.Severity} - {issue.Details.Text}");
}

// Validate each resource in the bundle
foreach (var entry in bundle.Entry)
{
    var resource = entry.Resource;
    var resourceResult = validator!.Validate(resource);
    foreach (var issue in resourceResult.Issue)
    {
        Console.WriteLine($"{issue.Severity} - {issue.Details.Text}");
    }
}
